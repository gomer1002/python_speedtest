<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LTE Speed Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
      }
      button {
        padding: 10px 20px;
        font-size: 1em;
        margin: 10px;
      }
      #results {
        margin-top: 20px;
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <h1>LTE Speed Test</h1>
    <p>
      Packet size:
      <input type="number" id="packetSize" value="1" min="1" step="1" /> MB
    </p>
    <p>
      Packet count:
      <input type="number" id="packetCount" value="100" min="1" step="1" />
    </p>
    <p>
      <button onclick="runDownloadTest()">Test Download Speed</button>
      <button onclick="runUploadTest()">Test Upload Speed</button>
    </p>

    <div id="results"></div>
    <script>
      const serverUrl = window.location.origin;

      async function runDownloadTest() {
        document.getElementById("results").innerText = `Testing . . .`;
        const packetCount = parseInt(
          document.getElementById("packetCount").value
        );
        const packetSize = parseInt(
          document.getElementById("packetSize").value
        );
        let totalBytesDownloaded = 0;
        let avg = 0.0;

        for (let i = 0; i < packetCount; i++) {
          let startTime = performance.now();
          let response = await fetch(
            `${serverUrl}/generate-data?size_in_mb=${packetSize}`
          );
          await response.blob();
          let endTime = performance.now();
          let duration = (endTime - startTime) / 1000;
          let speedMbps = (packetSize / duration) * 8;
          avg = avg + speedMbps;
          document.getElementById("results").innerText = `Download Speed ${
            i + 1
          }/${packetCount}: ${speedMbps.toFixed(2)} Mbps`;
        }
        avg = avg / packetCount;
        document.getElementById(
          "results"
        ).innerText = `Download Speed AVG: ${avg.toFixed(2)} Mbps`;
      }

      async function runUploadTest() {
        document.getElementById("results").innerText = `Testing . . .`;
        const packetCount = parseInt(
          document.getElementById("packetCount").value
        );
        const packetSize = parseInt(
          document.getElementById("packetSize").value
        );
        const data = new Blob(["0".repeat(packetSize * 1024 * 1024)]);
        let totalBytesDownloaded = 0;
        let avg = 0.0;

        for (let i = 0; i < packetCount; i++) {
          let startTime = performance.now();
          let response = await fetch(`${serverUrl}/upload-data`, {
            method: "POST",
            body: data,
          });
          let endTime = performance.now();
          let duration = (endTime - startTime) / 1000;
          let speedMbps = (packetSize / duration) * 8;
          avg = avg + speedMbps;
          document.getElementById("results").innerText = `Upload Speed ${
            i + 1
          }/${packetCount}: ${speedMbps.toFixed(2)} Mbps`;
        }
        avg = avg / packetCount;
        document.getElementById(
          "results"
        ).innerText = `Upload Speed AVG: ${avg.toFixed(2)} Mbps`;
      }
    </script>
  </body>
</html>
